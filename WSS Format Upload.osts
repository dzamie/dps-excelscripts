{"version":"0.3.0","body":"// changelog\n// 2025.10.09\n//   adding support for ANCH 5004\n//   currently assuming that Rent -> 1600 Storage Income\n// 2025.11.04\n//   updating coding for 5002: now goes to 5004 rather than 5001\n// \n\n\n// Goal: make and format data to fill in the white-column section of WSS Upload\n// Columns to fill: Date, Station, GL ACCT, Amount, Memo\n// Date: date of transaction. Offset (-3, -2) from 1600 cell\n// Station: station name. Same as sheet name EXCEPT 5002's station is 5001\n// GL ACCT: 7 static 4-digit #s, EXCEPT 5002 uses 1200 instead of 1600\n// Amount: values from formulae. If unscripted, fits in order with a transposed paste\n// Memo: Station concat with \"\" for card or block type elsewise (e.g. Check, Echeck)\n//       for ACCT 1065 and 1810, append \"DP\".\n//       If unscripted, filling in the first Memo line of a block will autofill\n\n// Script plan:\n// 0. Grab sheet list, append \"Upload\" sheet for output\n// 1. Label Upload columns for filtering later\n// 2. foreach sheet:\n//   0. find blocks with findall(\"1600 Current\")\n// 3. stitch together findall results\n// 4. foreach block:\n//   0. Grab date (offset (-3, -2) from 1600)\n//   1. Grab station (getWorksheet helps)\n//   2. Grab type (offset (-2, -2) from 1600)\n//   3. Grab data (offset ( 0, +1) from 1600, 1R7C size)\n//   4. Write to Upload in 7 rows: date, station, ACCT #s\n//      (IF sheet is 5002, write 1200 instead of 1600 and 5001 instead of 5002)\n//   5. Paste-value-transpose data into Amount column\n//   6. Memo: write station+(type?)+(DP?)\n// (for next step, see: https://stackoverflow.com/questions/73755902/officescripts-to-delete-visible-rows-after-filtering)\n// 5. activate filter, filter and delete Amount == 0\n// 6. clear filter\n// 7. set active cell to Upload!A1\n\n// readcell: the 1600 Current cell of the block\n// writecell: the first empty A-col cell in Upload\n// since this always writes 7 rows, writecell can be moved predictably after each call\nfunction processBlock(readcell: ExcelScript.Range, writecell: ExcelScript.Range) {\n    // 0. Grab date\n    let datecell = readcell.getOffsetRange(-2, -3)\n    // 1. Grab station\n    let statstr = readcell.getWorksheet().getName()\n    // 2. Grab type (offset (-2, -2) from 1600)\n    let typestr = readcell.getOffsetRange(-2, -2).getValue().toString()\n    if (typestr.includes(\"heck\") || // matches both Check and Echeck\n        typestr.includes(\"Cash\") ||\n        typestr.includes(\"Corp\") ||\n        typestr.includes(\"Repo\")) {\n            typestr = typestr\n    } else {\n        typestr = \"\" // credit cards get blanked\n    }\n    // 3. Grab data (offset ( 0, +1) from 1600, 1R7C size)\n    let datacell = readcell.getOffsetRange(1, 0).getAbsoluteResizedRange(1, 7)\n    // 4. Write to Upload in 7 rows: date, station, ACCT #s\n    //    (IF sheet is 5002, write 1200 instead of 1600 and 5001 instead of 5002)\n    // 5. Paste-value-transpose data into Amount column\n    // 6. Memo: write station+(type?)+(DP?)\n    // note: implementing as writing them all in one go, then transposing\n\n    // preparing the \"columns\"\n    let datearr = Array<string>(7)\n    let statarr = Array<string>(7)\n    let acctarr = [1600, 1804, 1808, 3709, 4100, 1065, 1810]\n    let dataarr = datacell.getValues()[0]\n    let memoarr = Array<string>(7)\n    datearr.fill(datecell.getValue().toString())\n    // as of Nov 2025, Anch Airport goes to 5004 instead of 5001\n    if (statstr.includes(\"5002\")) {\n        statarr.fill(\"5004\")\n        acctarr[0] = 1200\n    } else {\n        statarr.fill(statstr)\n    }\n    memoarr.fill(statstr + \" \" + typestr)\n    memoarr[5] = memoarr[5] + \" DP\"\n    memoarr[6] = memoarr[6] + \" DP\"\n    // stitch \"columns\" together\n    let transarr = [datearr, statarr, acctarr, dataarr, memoarr]\n    // thank you Fawad Ghafoor on StackOverflow\n    let writearr = transarr[0].map((col, i) => transarr.map(row => row[i]))\n    writecell.getAbsoluteResizedRange(7, 5).setValues(writearr)\n}\n\n\nfunction main(workbook: ExcelScript.Workbook) {\n    // 0. Grab sheet list, append \"Upload\" sheet for output\n    let sheets = workbook.getWorksheets()\n    let upload = workbook.addWorksheet(\"Upload\")\n\n    // 1. Label Upload columns for filtering later\n    upload.getRange(\"A1:E1\").setValues([[\"Date\", \"Station\", \"ACCT\", \"Amount\", \"Memo\"]])\n\n    // 2. foreach sheet:\n    let currents = Array<ExcelScript.Range>()\n    for(let i = 0; i < sheets.length; i ++ ) {\n        // 0. find blocks with findall(\"1600 Current\")\n        // (3. stitch together findall results)\n        currents.push(...sheets[i].findAll(\"1600 Current\", {}).getAreas())\n    }\n\n    // 4. foreach block: process block\n    let writerow = 2 // A1 of next empty upload row, increments by 7 per call\n    for(let i = 0; i < currents.length; i ++) {\n        processBlock(currents[i], upload.getRange(\"A\" + writerow.toString()))\n        writerow += 7\n    }\n    // (for next step, see: https://stackoverflow.com/questions/73755902/officescripts-to-delete-visible-rows-after-filtering)\n    // 5. activate filter, filter and delete Amount == 0\n    let filterrange = upload.getUsedRange(true)\n    let upfilter = upload.getAutoFilter()\n    upfilter.apply(upload.getRange(\"A1:E1\"))\n    upfilter.apply(upfilter.getRange(), 3, {filterOn: ExcelScript.FilterOn.values, values: [\"0\"]})\n    let lastrow = upload.getRange(\"A1048576\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 1 // A1 row of last thing with a 0\n    upload.getRange(\"2:\" + lastrow.toString()).delete(ExcelScript.DeleteShiftDirection.up)\n    upfilter.clearCriteria()\n    // 6. clear filter (eh, basically done)\n    // new 6. add a line between cities\n    // this used to be B:B, but that errored for some reason\n    // extendedrange is more consistent\n    let stationcells = upload.getRange(\"B1\").getExtendedRange(ExcelScript.KeyboardDirection.down).getValues()\n    let stations = stationcells.map((row) => row[0])\n    // map so that it's [B1, B2] not [[B1], [B2]]\n    let uline: number = undefined\n    let aline: number = undefined\n    for(let i = 0; i < stations.length; i ++) {\n        // undefined is falsey - useful!\n        // quickly jumps past if statements once defined\n        if(!uline && /^U/.test(stations[i].toString())) {\n            uline = i\n        }\n        // using regex because builtin find will match \"B500\" containing \"500\" when trying to match \"5001/2\"\n        if(!aline && /^5/.test(stations[i].toString())) {\n            aline = i\n        }\n    }\n    // SLC will offset anch if exists and done first\n    // going upwards means not dealing with either\n    // using +1 to translate from 0-indexed array to 1-indexed A1 address\n    if (aline) {\n        upload.getRange(`${aline + 1}:${aline + 1}`).insert(ExcelScript.InsertShiftDirection.down)\n    }\n    if (uline) {\n        upload.getRange(`${uline + 1}:${uline + 1}`).insert(ExcelScript.InsertShiftDirection.down)\n    }\n    \n    // 7. set active cell to Upload!A1\n    upload.getRange(\"A2\").select()\n\n}\n","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}