{"version":"0.3.0","body":"/* Post-Nov-2025 PBP\n * \n * Human instructions:\n *  1. Drag template into PBP book\n *  2. Copy 2x4 label+formulas from prior book to Backoffice Reports AK1:AN2\n *  3. (fix the VLookup one so it's just looking at the current book)\n *  4. Select Column V (PBP Loc ID), Data -> Text to Columns -> Finish\n *  5. Autofill the 4 columns to bottom of data (Ctrl+D)\n *  6. Make new sheet for Pivot Table\n *  7. Point Pivot Table at Backoffice Reports\n *  8. Filter: Payment Status, Purchase ID\n *  9. Rows: Payment Date (Day), Client Lot ID\n * 10. Cols: Parking Amount2, DPS Fee, ACH\n * 11. Filter Payment Status: APPROVED\n * 12. Filter Purchase ID: everything BUT #N/A\n * 13. Copy Lot IDs into template twice: once for NS 735, once for 2206\n * 14. (fill in NS Account #s and dates)\n * 15. Copy Parking Amount2 to 735 rows\n * 16. Copy DPS Fee to 2206 rows\n * 17. Check for #N/A External IDs, clean up Ghost Codes and rogue date summaries\n * 18. Filter to Amount=0, delete those rows\n * 19. Sort Date -> Station -> NS Account\n * 20. Delete blank rows\n * 21. Check company totals against Summary, mark 11/12 sums\n * 22. Save, close, reopen, export to .csv\n */\n\n/* Automation plan:\n * 00. (Human) Drag template into PBP book\n * 01. Write Parking Amount, PBP Fee, DPS Fee, ACH to Backoffice AK1:AN1\n * 02. Write =+J2, =VLOOKUP(V2,'Fee Schedule'!A:B,2,FALSE), =+S2-AL2, =+AK2+AM2 to AK2:AN2\n * 03. Find last A#, autoFill AK2:AN2 to AK#:AN#\n *   *** update: add \"Trans Date\" column with round(numbervalue,0) so that the date pivot works properly\n * 04. Take V2:V#, map Number(val), setValues with the numbers\n * 05. Make new sheet, add Pivot Table to it: A1:AN#:\n *   00. AddColumnHierarchy: day, Client Lot ID\n *   01. AddDataHierarchy: Parking Amount2, DPS Fee, ACH\n *   02. AddFilterHierarchy: Purchase ID, Payment Status\n *   03. make ExcelScript.PivotLabelFilters: both beginsWith, substring \"APPROVED\" and \"#N/A\", exclusive false and true respectively\n *   04. each filterhierarchy.applyfilter({labelfilter: filter})\n *   05. foreach day in date.getitems: day.setisexpanded(true)\n *   06. table.getlayout.setlayouttype(tabular) (makes days easier)\n * 06. Set F4 = \"=A4+0\" (looking for dates)\n * 07. Find bottom of pivot table \"#\" (incl. grand total)\n * 08. Make new sheet for template-filler, head with Date, Station, NS Account, Amount\n * 09. Copy pivot!F4:F# to template!a2, save lowest row value \"%\", copy again\n * 10. Copy pivot!B4:B# to template!b2, twice\n * 11. Write 735 to template!c2:c%, 2206 to c(%+1):c(2%-1)\n * 12. Copy pivot!C4:C# to template!d2:d%\n * 13. Copy pivot!D4:D# to template!d(%+1):d(2%-1)\n * 14. template!B:B replaceall(\" - Ghost Code\", \"\", blank criteria)\n * 15. apply autofilter: A? = #VALUE\n * 16. A2->down .delete\n * 17. apply autofilter: D? = 0\n * 18. A2->down .delete\n * 19. unfilter (filter.remove)\n * 20. sort col a -> col b -> col c\n */\n\nfunction process(workbook: ExcelScript.Workbook) {\n  // 00. (Human) Drag template into PBP book\n\n  // 01. Write Parking Amount, PBP Fee, DPS Fee, ACH, Trans Date to Backoffice AK1:AO1\n  // 02. Write =+J2, =VLOOKUP(V2,'Fee Schedule'!A:B,2,FALSE), =+S2-AL2, =+AK2+AM2, =ROUND(NUMBERVALUE(C2),0) to AK2:AO2\n  let backoffice = workbook.getWorksheet(\"PBP Backoffice Reports \")\n  backoffice.getRange(\"AK1:AO2\").setFormulas([[\"Parking Amount2\", \"PBP Fee\", \"DPS Fee\", \"ACH\", \"Trans Date\"], [\"=+J2\", \"=VLOOKUP(V2, 'Fee Schedule'!A:B,2,FALSE)\", \"=+S2-AL2\", \"=+AK2+AM2\", \"=ROUND(NUMBERVALUE(C2),0)\"]])\n\n  // 03. Find last A#, autoFill AK2:AN2 to AK#:AN#\n  let lastRow = backoffice.getRange(\"A1\").getRangeEdge(ExcelScript.KeyboardDirection.down).getRowIndex() + 1 // +1 to offset 0-index for later A1 use\n\n  // 04. Take V2:V#, map Number(val), setValues with the numbers\n  let vee = backoffice.getRange(\"V2:V\" + lastRow.toString()).getValues()\n  let veenum = vee.map((x) => [Number(x[0])])\n  backoffice.getRange(\"V2:V\" + lastRow.toString()).setValues(veenum)\n\n  // 05. Make new sheet, add Pivot Table to it: A1:AN#:\n  let pivotSheet = workbook.addWorksheet(\"Report Pivot\")\n  pivotSheet.setPosition(2) // should put it right next to the reports\n  let reportPivot = pivotSheet.addPivotTable(\"ReportPivot\", \"A1:AO\" + lastRow.toString(), \"A1\")\n\n  //   00. AddColumnHierarchy: day, Client Lot ID\n  reportPivot.addColumnHierarchy(reportPivot.getHierarchy(\"Trans Date\"))\n  reportPivot.addColumnHierarchy(reportPivot.getHierarchy(\"Client Lot ID\"))\n  //   01. AddDataHierarchy: Parking Amount2, DPS Fee, ACH\n  reportPivot.addDataHierarchy(reportPivot.getHierarchy(\"Parking Amount2\"))\n  reportPivot.addDataHierarchy(reportPivot.getHierarchy(\"DPS Fee\"))\n  reportPivot.addDataHierarchy(reportPivot.getHierarchy(\"ACH\"))\n  //   02. AddFilterHierarchy: Purchase ID, Payment Status\n  //   03. make ExcelScript.PivotLabelFilters: both beginsWith, substring \"APPROVED\" and \"#N/A\", exclusive false and true respectively\n  //   04. each filterhierarchy.applyfilter({labelfilter: filter})\n  //   05. foreach day in date.getitems: day.setisexpanded(true)\n  //   06. table.getlayout.setlayouttype(tabular)\n  // 06. Set F4 = \"=A4+0\" (looking for dates)\n  // 07. Find bottom of pivot table \"#\" (incl. grand total)\n  // 08. Make new sheet for template-filler, head with Date, Station, NS Account, Amount\n  // 09. Copy pivot!F4:F# to template!a2, save lowest row value \"%\", copy again\n  // 10. Copy pivot!B4:B# to template!b2, twice\n  // 11. Write 735 to template!c2:c%, 2206 to c(%+1):c(2%-1)\n  // 12. Copy pivot!C4:C# to template!d2:d%\n  // 13. Copy pivot!D4:D# to template!d(%+1):d(2%-1)\n  // 14. template!B:B replaceall(\" - Ghost Code\", \"\", blank criteria)\n  // 15. apply autofilter: A? = #VALUE\n  // 16. A2->down .delete\n  // 17. apply autofilter: D? = 0\n  // 18. A2->down .delete\n  // 19. unfilter (filter.remove)\n  // 20. sort col a -> col b -> col c\n}\n\nfunction main(workbook: ExcelScript.Workbook) {\n\n    // Get the active cell and worksheet.\n    let selectedCell = workbook.getActiveCell();\n    let selectedSheet = workbook.getActiveWorksheet();\n    \n    let rng = workbook.getWorksheet(\"PBP Backoffice Reports \").getRange(\"A1:C5\")\n\n    let pivot = selectedSheet.getPivotTable(\"pivot?\")\n    pivot.delete()\n\n    pivot = selectedSheet.addPivotTable(\"pivot?\", rng, selectedSheet.getRange(\"A1\"))\n    pivot.addColumnHierarchy(pivot.getHierarchy(\"Payment Date\"))\n\n    // let hrs = pivot.getHierarchies()\n    // hrs.forEach((x) => console.log(x.getName()))\n\n}\n","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}