{"version":"0.3.0","body":"\r\n// TODO: implement Echeck CC fee (-.17*echeck count, into 3709)\r\n\r\n\r\nfunction formatSheet(sheet: ExcelScript.Worksheet) {\r\n\r\n\t// Procedure:\r\n\t// Rename sheet to Station (B500, B600, U131, U130, 5001, 5003, 5002)\r\n\t// ----- If using this script, this must be done manually\r\n\t// Separate records by date, then by card/check/echeck/etc\r\n\t// 4 empty rows between each\r\n\t// Convert cols D-T into numbers, replace remaining \"-\" cells in D with $0\r\n\t// Copy/paste formula block under each set of records...\r\n\t// Important! upper-left cell of pasted block MUST be on the ->\r\n\t//   2nd inserted row, in col E (Late Fees). This leaves one ->\r\n\t//   empty row above and one below.\r\n\t// Paste CC trans details directly to the right of the CC blocks\r\n\t// ----- If using this script, manually paste *after* script runs\r\n\t// Most times, they should line up, making a clean block of records\r\n\t// Autosum cols D-AB on CC blocks, D-T on non-CC blocks\r\n\t// ----- This script ends here.\r\n\t// Verify that the (rightmost) checksum for CC formula block is $0\r\n\t// On upload sheet: fill out date, station, memo columns\r\n\t// GL ACCT colum should be pre-filled, but in case it isn't, in order:\r\n\t// 1600 1804 1808 3709 4100 1065\r\n\t// Important! For station 5002, the Station is 5001, Memo is 5002, and ->\r\n\t//   replace 1600 with 1200 in GL ACCT. Do not forget to do this!\r\n\t// Remove rows with $0 amounts\r\n\t// Remove empty rows\r\n\t// Save and export Upload sheet\r\n\r\n\tlet echeckFee = \"=-0.17*\" // change this if the echeck fee changes\r\n\r\n\t// enable those pretty red ($3.45) formats\r\n\tsheet.getRange(\"D:T\").setNumberFormat(\"$#,##0.00_);[Red]($#,##0.00)\")\r\n\r\n\tlet drange = sheet.getUsedRange(true)\r\n\r\n\t// set up for autosums (if possible)\r\n\tlet rentcol = sheet.getRange(\"D:D\")\r\n\trentcol.replaceAll(\"-$\", \"a$\", {})\r\n\trentcol.replaceAll(\"-\", \"$0\", {})\r\n\trentcol.replaceAll(\"a$\", \"-$\", {})\r\n\r\n\t// this is the \"change to number\" done to everything\r\n\t// needs to happen AFTER replacing - with $0, otherwise it'll strip '$' from strings\r\n\tdrange.setValues(drange.getValues())\r\n\r\n\t// sort by date, then by type\r\n\t// replaces used to artificially push non-CCs to the bottom\r\n\tsheet.replaceAll(\"Chec\", \"zvChec\", { matchCase: true }) // Check\r\n\tsheet.replaceAll(\"Eche\", \"zwEche\", { matchCase: true }) // Echeck\r\n\tsheet.replaceAll(\"Cash\", \"zxCash\", { matchCase: true }) // Cash\r\n\tsheet.replaceAll(\"Corp\", \"zyCorp\", { matchCase: true }) // Corporate\r\n\tsheet.replaceAll(\"Repo\", \"zzRepo\", { matchCase: true }) // Reporting Applied Credit\r\n\tdrange.getSort().apply(\r\n\t\t[{\r\n\t\t\tkey: 1, // Date\r\n\t\t\tascending: true\r\n\t\t}, {\r\n\t\t\tkey: 2, // Type\r\n\t\t\tascending: true\r\n\t\t}],\r\n\t\tfalse,\r\n\t\ttrue\r\n\t)\r\n\tsheet.replaceAll(\"zvChec\", \"Chec\", { matchCase: true })\r\n\tsheet.replaceAll(\"zwEche\", \"Eche\", { matchCase: true })\r\n\tsheet.replaceAll(\"zxCash\", \"Cash\", { matchCase: true })\r\n\tsheet.replaceAll(\"zyCorp\", \"Corp\", { matchCase: true })\r\n\tsheet.replaceAll(\"zzRepo\", \"Repo\", { matchCase: true })\r\n\r\n\t// okay let's do this faster\r\n\tlet lastrow = sheet.getRange(\"A9999\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 1 // last filled row in A1\r\n\tlet sepList = Array<number>() // list of rows to prepend with 4 blank lines - will have to add to account for moving lines\r\n\tlet dateTypeCells = sheet.getRange(\"B2:C\" + lastrow.toString()).getValues()\r\n\tlet typelist = [\"Check\", \"Echeck\", \"Cash\", \"Corp\", \"Report\"]\r\n\tlet changed = false\r\n\tfor(let i = 0; i < dateTypeCells.length - 1; i ++) { // remember: dtc[0] is row 2\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t // and this is the previous row, so add 1 more\r\n\t\tchanged = false\r\n\t\tif(dateTypeCells[i][0] != dateTypeCells[i+1][0]) {\r\n\t\t\tchanged = true\r\n\t\t\t// console.log(\"Date change: \" + dateTypeCells[i][0].toLocaleString() + \" -> \" + dateTypeCells[i+1][0].toLocaleString())\r\n\t\t}\r\n\t\tfor(let j = 0; j < typelist.length; j ++) {\r\n\t\t\tif(dateTypeCells[i+1][1].toString().includes(typelist[j])) { // non-cc type\r\n\t\t\t\tif(dateTypeCells[i][1] != dateTypeCells[i+1][1]) { // first of its non-cc type\r\n\t\t\t\t\tchanged = true\r\n\t\t\t\t\t// console.log(\"Type change: \" + dateTypeCells[i][1].toString() + \" -> \" + dateTypeCells[i+1][1].toString())\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(changed) {\r\n\t\t\tsepList.push(i+3)\r\n\t\t\t// ex: 1 row of cc, then check immediately after. need to put newlines before row 3, so i=0, push 3\r\n\t\t}\r\n\t}\r\n\tsepList.push(sheet.getRange(\"A9999\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 2)\r\n\tconsole.log(sepList)\r\n\t// sheet.getRange(\"A0\") // perish\r\n\t// seplist populated, time to offset and make lines\r\n\tfor(let i = 0; i < sepList.length; i ++) {\r\n\t\tsepList[i] += 4*i // offset (remember: seplist lines are *after* the newlines)\r\n\t\tfor(let j = 0; j < 4; j ++) {\r\n\t\t\tsheet.getRange(sepList[i].toString() + \":\" + sepList[i].toString()).insert(ExcelScript.InsertShiftDirection.down)\r\n\t\t}\r\n\t\t// while we're here, let's go ahead and populate that space\r\n\t\tlet c1 = sheet.getRange(\"D\" + (sepList[i]).toString()) // rent autosum cell\r\n\t\tlet r0 = c1.getOffsetRange(-1,0).getExtendedRange(ExcelScript.KeyboardDirection.up) // rent cells\r\n\t\tif(r0.getSpecialCells(ExcelScript.SpecialCellType.blanks) != undefined) {\r\n\t\t\t// triggers on a 1-row block, since it will try to capture up to the previous block\r\n\t\t\t// may not trigger on first block, but that's fine b/c strings eval to 0 in SUM()\r\n\t\t\tr0 = c1.getOffsetRange(-1,0)\r\n\t\t}\r\n\t\tc1.setValue(\"=SUM(\" + r0.getAddress() + \")\")\r\n\t\tc1.autoFill(c1.getAbsoluteResizedRange(1,25)) // autosums done\r\n\t\tlet rowstr = (c1.getRowIndex() + 1).toString()\r\n\t\tlet formulaList = [\r\n\t\t\t[\"1600 Current\",\r\n\t\t\t\t\"1804 INS\",\r\n\t\t\t\t\"1808 ADM\",\r\n\t\t\t\t\"3709 CC Fee\",\r\n\t\t\t\t\"4100 U-HAUL\",\r\n\t\t\t\t\"1065 RETAIL\",\r\n\t\t\t\t\"1810 LATE\",\r\n\t\t\t\t\"\",\r\n\t\t\t\t\"\"],\r\n\t\t\t[\"=D\" + rowstr + \"+O\" + rowstr + \"+P\" + rowstr,\r\n\t\t\t\"=K\" + rowstr,\r\n\t\t\t\"=F\" + rowstr + \"+G\" + rowstr + \"+H\" + rowstr + \"+I\" + rowstr + \"+L\" + rowstr,\r\n\t\t\t\"=-Z\" + rowstr,\r\n\t\t\t\"=-AA\" + rowstr,\r\n\t\t\t\"=J\" + rowstr + \"+R\" + rowstr,\r\n\t\t\t\"=E\" + rowstr,\r\n\t\t\t\"=SUM(\" + c1.getOffsetRange(2,1).getAbsoluteResizedRange(1,7).getAddress() + \")\",\r\n\t\t\t\"=L\" + (c1.getRowIndex()+3).toString() + \"-AB\" + rowstr]\r\n\t\t]\r\n\r\n\t\tif(r0.getOffsetRange(0,-1).getValue().toString().includes(\"Echeck\")) { // a bit slow but hopefully not bad\r\n\t\t\t// looking for Echecks to set the 3709 CC Fee\r\n\t\t\tformulaList[1][3] = echeckFee + r0.getRowCount().toString() // wait why are YOU slow? eh.\r\n\t\t}\r\n\t\t\r\n\t\tlet formulaRange = c1.getOffsetRange(1,1).getAbsoluteResizedRange(2,9)\r\n\t\tformulaRange.setFormulas(formulaList)\r\n\t\t// coloring time :)\r\n\t\tformulaRange.getAbsoluteResizedRange(1, 7).getFormat().getFill().setColor(\"#00B0F0\")\r\n\t}\r\n\t// console.log(sepList)\r\n\r\n\r\n\t// final bit of aesthetic\r\n\tsheet.getRange(\"2:2\").insert(ExcelScript.InsertShiftDirection.down)\r\n\tsheet.getRange(\"L:L\").getFormat().autofitColumns()\r\n}\r\n\r\nfunction main(workbook: ExcelScript.Workbook) {\r\n\tlet sheets = workbook.getWorksheets()\r\n\tfor(let i = 0; i < sheets.length; i ++ ) {\r\n\t\tformatSheet(sheets[i])\r\n\t\tconsole.log(\"Finished \" + sheets[i].getName())\r\n\t}\r\n}","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}