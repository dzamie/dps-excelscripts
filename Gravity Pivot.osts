{"version":"0.3.0","body":"/*\n\nBasic:\n1. on a new sheet, make a pivot table at A1 by Overhead and Amount\n2. set Number format on A1:C25 to comma-separated x.xx\n3. C[KNG] = KNG + UDT\n4. C[LGB] = LGB + SAA\n5. set active cell to A1\n\nAdvanced:\n1. grab all Overheads and Amounts from \"Gravity Upload\" sheets into an array\n2. drop them into appropriately labeled columns (J,K) in a new sheet\n3. repeat Basic with the labeled columns as the source\n\n*/\n\n\nfunction basic(workbook: ExcelScript.Workbook) {\n    // 1. on a new sheet, make a pivot table at A1 by Overhead and Amount\n    // note: this function MUST start on the upload template\n    let sourceSheet = workbook.getActiveWorksheet()\n    let sourceRange = sourceSheet.getUsedRange()\n    workbook.addWorksheet(\"J's Tables\")\n    let sheet = workbook.getWorksheet(\"J's Tables\")\n    let pivot = sheet.addPivotTable(\"totalSheet\", sourceRange, sheet.getRange(\"A1\"))\n    pivot.addRowHierarchy(pivot.getHierarchy(\"Overhead\"))\n    pivot.addDataHierarchy(pivot.getHierarchy(\"Amount\"))\n    // turn the pivot table into an array for speed\n    let pvtVals = sheet.getRange(\"A1:B1\").getExtendedRange(ExcelScript.KeyboardDirection.down).getValues()\n\n\n    // 2. set Number format on A1:C25 to comma - separated x.xx \"#,##0.00\"\n    sheet.getRange(\"B1:C25\").setNumberFormat(\"#,##0.00\")\n\n    // 3. C[KNG] = KNG + UDT\n    // 4. C[LGB] = LGB + SAA\n    let kng = pvtVals.findIndex(row => row[0].toString().includes(\"KNG\"))\n    let udt = pvtVals.findIndex(row => row[0].toString().includes(\"UDT\"))\n    let lgb = pvtVals.findIndex(row => row[0].toString().includes(\"LGB\"))\n    let saa = pvtVals.findIndex(row => row[0].toString().includes(\"SAA\"))\n    sheet.getRange(\"C\" + (kng+1).toString()).setValue(\n        parseFloat(pvtVals[kng][1].toString()) + parseFloat(pvtVals[udt][1].toString())\n    )\n    sheet.getRange(\"C\" + (lgb + 1).toString()).setValue(\n        parseFloat(pvtVals[lgb][1].toString()) + parseFloat(pvtVals[saa][1].toString())\n    )\n\n    // 5. set active cell to A1\n    sheet.getRange(\"A1\").select()\n}\n\nfunction advanced(workbook: ExcelScript.Workbook) {\n    // 1. grab all Overheads and Amounts from \"Gravity Upload\" sheets into an array\n    let sheet = workbook.addWorksheet(\"J's Tables\")\n    let dataArray = new Array<Array<string | number | boolean>>()\n    let sourceSheets = workbook.getWorksheets().filter(ws => ws.getName().includes(\"Gravity Upload\"))\n    console.log(\"Found \" + sourceSheets.length.toString() + \" source sheets.\")\n    for(let i = 0; i < sourceSheets.length; i ++) {\n        let sourceArray = sourceSheets[i].getRange(\"A1\").getExtendedRange(ExcelScript.KeyboardDirection.right).getExtendedRange(ExcelScript.KeyboardDirection.down).getValues()\n        let headers = sourceArray[0]\n        let amtInd = headers.findIndex(cell => cell.toString().includes(\"Amount\"))\n        let ovrInd = headers.findIndex(cell => cell.toString().includes(\"Overhead\"))\n        // isolate the Amount and Overhead columns\n        let newVals = sourceArray.slice(1).map(row => [row[ovrInd], row[amtInd]])\n        // append the isolated columns to dataArray\n        dataArray = dataArray.concat(newVals)\n        console.log(\"Added \" + newVals.length.toString() + \" rows from template \" + i.toString() + \".\")\n    }\n\n    console.log(\"Final size: \" + dataArray.length.toString() + \".\")\n\n    // 2. drop them into appropriately labeled columns (J,K) in a new sheet\n    sheet.getRange(\"J2\").getAbsoluteResizedRange(dataArray.length, 2).setValues(dataArray)\n    sheet.getRange(\"J1:K1\").setValues([[\"Overhead\", \"Amount\"]])\n\n    // 3. repeat Basic with the labeled columns as the source\n    let pvt = sheet.addPivotTable(\"Gravity Sums\", sheet.getRange(\"J1:K1\").getExtendedRange(ExcelScript.KeyboardDirection.down), \"A1\")\n    pvt.addRowHierarchy(pvt.getHierarchy(\"Overhead\"))\n    pvt.addDataHierarchy(pvt.getHierarchy(\"Amount\"))\n    sheet.getRange(\"B1:C25\").setNumberFormat(\"#,##0.00\")\n    let pvtArr = sheet.getRange(\"A1:B1\").getExtendedRange(ExcelScript.KeyboardDirection.down).getValues()\n    let inds = [\"KNG\",\"UDT\",\"LGB\",\"SAA\"].map(str => pvtArr.findIndex(row => row[0].toString().includes(str)))\n    let amts = inds.map(ind => parseFloat(pvtArr[ind][1].toString()))\n\n    sheet.getRange(\"C\" + (inds[0]+1).toString()).setValue(amts[0] + amts[1])\n    sheet.getRange(\"C\" + (inds[2]+1).toString()).setValue(amts[2] + amts[3])\n    sheet.getRange(\"A1\").select()\n}\n\nfunction main(workbook: ExcelScript.Workbook) {\n    advanced(workbook)\n\n}\n","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}