{"version":"0.3.0","body":"// Changelog:\n//\n// 17-04-2025: Combined sometimes \"starts\" on row 3. Updated to counteract this. Step 05a.\n\n\n// Procedure:\n//  1. Move template into workbook, just after Combined for ease\n//  2. In SMS Report, set all of Col A's number format to Date\n//  3. Duplicate Pivot SMS Report, just before Combined for ease\n//  4. In the Pivot Copy, disable Name field, enable Payment Completed Date, then enable Location ID (Client)\n//  5. Refresh All Data in the Pivot Copy\n//  6. In Combined, set all column widths to 8.43 (visibility)\n//  7. Hide columns J-N (visibility)\n//  8. Filter and delete everything with:\n//    a. Payment Status = DECLINED, and/or\n//    b. Region Name is one of the DPS MOR cities:\n//      Anchorage, Ashland, Bend, Boise, Eugene, Honolulu,\n//      Kona, Maui, Montana, Oregon, Salt Lake\n//  9. Sort data by Payment Completed Date, then by Client Lot ID\n// 10. Color Client Lot ID and Parking Fee Total columns orange (aesthetic)\n// 11. Copy/paste Combined!Y1:AG2 from an earlier PBP file to this one\n// 12. Copy/paste-values the 3 columns in the Pivot Copy to Y2 in Combined\n// 13. Select AB2:AG2, double-click the little square to autofill down\n// 14. Top-to-bottom, look for when column AC is FALSE\n// 15. Compare Row Label to Client Lot ID:\n//    a. If RL doesn't appear in CLID, delete Y:AA for that row, shifting up\n//    b. If CLID is the *previous* RL, insert new cells above Y:AA and copy the previous RL to the empty one below it\n// 16. Regardless, select AB:AG from an earlier TRUE row and autofill again\n// 17. Verify that all the data is a nice neat rectangle, and AC is all TRUE\n// 18. Copy the dates from Combined into the template, then again underneath\n// 19. Same with Combined!Client Lot ID -> template!Station\n// 20. For NS Account, it's 735 for the first copy of the dates/IDs, and 2206 for the second one\n// 21. Copy Payment Total into Amount for the 735 rows\n// 22. Copy DPS Fees into Amount for the 2206 rows\n// 23. Filter and delete $0 amounts\n// 24. Filter and fix all \"N/A\" company numbers in the yellow zone (mostly will be removing Ghost Codes)\n// 25. Sort by Date -> Station -> NS Account\n// 26. Verify the totals match the Summary page\n// 27. Save workbook, export template as CSV\n\n// Code Plan:\n// 00. Make Output sheet for copying, A1:D1 Date, Station, NS Account, Amount\n// 01. In \"SMS Report\", set Col A num format to \"yyyy-mm-dd\"\n// 02. Make Pivot Copy sheet, add new Pivot Table at A1\n// 03. Row Fields: \"Payment Completed (Local) Date\", \"Location ID (Client)\"\n// 04. Column Fields: \"SMS Reminder Amount\", \"SMS Confirmation Amount\"\n// 05. In \"Combined\", set A:AG width to 8.43\n// 06. Hide J:N (set width to 0?)\n// 07. Filter and delete Region Name (4) \"Diamond Parking - \" + ...\n//     \"Anchorage\", \"Ashland\", \"Bend\", \"Boise\", \"Eugene\", \"Honolulu\", \"Kona\", \"Maui\", \"Montana\", \"Oregon\", \"Salt Lake City\"\n// 08. Filter and delete Payment Status (8) \"DECLINED\"\n// 09. Sort active range by Payment Date (0), Client Lot ID (6)\n// 10. Fill G:G, R:R, AE:AE with #FFC000\n// 11. Copy from Pivot Copy!A1:Clast to Combined!Y1\n// 12. Read G2:Glast and Y2:Ylast into arrays for faster reading (use values to avoid '34 != 34)\n// 13. Keeping separate indexes for G nav and Y nav:\n//   00. if G[i] == Y[j], increment i and j\n//   01. elif G[i] == Y[j-1] (i.e. multiline CLotID):\n//     00. insert cells above Y[i]:AA[i] (note, using G's index)\n//     01. copy Y[j-1] into cell Y[i]\n//     02. increment i, do not increment j\n//   02. else (i.e. extra pivot lot):\n//     00. delete cells at Y[j]:AA[j] (using Y's index)\n//     01. do not increment i, increment j\n// 14. Check: Read G2:Glast and Y2:Ylast again, compare. Throw error if it doesn't match.\n// 15. Write \"Total SMS Fees\", \"\", \"Final ACH Amt\", \"DPS Fees\" to AB1:AE1\n// 16. Write \"=Z2+AA2\", \"=Y2=G2\", \"=+W2-AB2\", \"=+AD2-R2\", \"=+AE2/0.99\", \"=IF(S2=0.35,0,0.99*J2)\" to AB2:AG2\n// 17. Autofill AB2:AG2 down to Ylast\n// 18. Store Ylast.getRowIndex() as recordCount\n// 19. Copy Combined!A2:Alast to Output!A2\n// 20. Copy Combined!A2:Alast to Output!A[recordCount+2]\n// 21. Copy Combined!G2:Glast to Output!B2\n// 22. Copy Combined!G2:Glast to Output!B[recordCount+2]\n// 23. Write 735 to Output!C2:C[recordCount+1]\n// 24. Write 2206 to Output!C[recordCount+2]:C[2*recordCount+1]\n// 25. Copy Combined!R2:Rlast to Output!D2\n// 26. Copy Combined!AE2:AElast to Output!D[recordCount+2]\n// 27. Add autofilter, filter and delete Amount (3) == 0\n// 28. Sort by Date -> Station -> NS Account\n// 29. Human Input: copy to template, fix N/A, verify, and save!\n\n\n\nfunction pbp(workbook: ExcelScript.Workbook) {\n  let smssheet = workbook.getWorksheet(\"SMS Report\")\n\n  // 00. Make Output sheet for copying, A1:D1 Date, Station, NS Account, Amount\n  let outsheet = workbook.addWorksheet(\"Output\")\n  outsheet.getRange(\"A:A\").setNumberFormat(\"mm/dd/yyyy\")\n  outsheet.getRange(\"A1:D1\").setValues([[\"Date\", \"Station\", \"NS Account\", \"Amount\"]])\n  outsheet.getRange(\"A1\").getFormat().setColumnWidth(77.25)\n  outsheet.getRange(\"B1\").getFormat().setColumnWidth(114.75)\n  outsheet.getRange(\"C1\").getFormat().setColumnWidth(101.25)\n  outsheet.getRange(\"D1\").getFormat().setColumnWidth(87.75)\n\n  // 01. In \"SMS Report\", set Col A num format to \"yyyy-mm-dd\"\n  workbook.getWorksheet(\"SMS Report\").getRange(\"A:A\").setNumberFormat(\"yyyy-mm-dd\")\n\n  // 02. Make Pivot Copy sheet, add new Pivot Table at A1\n  let pvtsheet = workbook.addWorksheet(\"Pivot Copy\")\n  let smspivot = pvtsheet.addPivotTable(\"Copy\", smssheet.getRange(\"A:L\"), pvtsheet.getRange(\"A1\"))\n\n  // 03. Row Fields: \"Payment Completed (Local) Date\", \"Location ID (Client)\"\n  smspivot.addRowHierarchy(smspivot.getHierarchy(\"Payment Completed (Local) Date\"))\n  smspivot.addRowHierarchy(smspivot.getHierarchy(\"Location ID (Client)\"))\n\n  // 04. Column Fields: \"SMS Reminder Amount\", \"SMS Confirmation Amount\"\n  smspivot.addDataHierarchy(smspivot.getHierarchy(\"SMS Reminder Amount\"))\n  smspivot.addDataHierarchy(smspivot.getHierarchy(\"SMS Confirmation Amount\"))\n\n  // 05. In \"Combined\", set A:AG width to 48\n  let combined = workbook.getWorksheet(\"Combined\")\n  combined.getRange(\"A:AG\").getFormat().setColumnWidth(48)\n\n  // 05a. Detect if rows 1-2 are \"hidden\"/superfluous, and delete them if so.\n  // also unfreeze the rows, for readability reasons\n  if(combined.getRange(\"A3\").getText().includes(\"Local\")) {\n    combined.getRange(\"1:2\").delete(ExcelScript.DeleteShiftDirection.up)\n    combined.getFreezePanes().unfreeze()\n  }\n\n  // 06. Hide J:N\n  combined.getRange(\"J:N\").setColumnHidden(true)\n\n  // 07. Filter and delete Region Name (4) \"Diamond Parking - \" + ...\n  //     \"Anchorage\", \"Ashland\", \"Bend\", \"Boise\", \"Eugene\", \"Honolulu\", \"Kona\", \"Maui\", \"Montana\", \"Oregon\", \"Salt Lake City\"\n  let cityarr = [\"Diamond Parking - Anchorage\", \"Diamond Parking - Ashland\", \"Diamond Parking - Bend\", \"Diamond Parking - Boise\", \"Diamond Parking - Eugene\", \"Diamond Parking - Honolulu\", \"Diamond Parking - Kona\", \"Diamond Parking - Maui\", \"Diamond Parking - Montana\", \"Diamond Parking - Oregon\", \"Diamond Parking - Salt Lake City\"]\n  let comfiltr = combined.getAutoFilter()\n  comfiltr.apply(combined.getRange(\"A:W\"), 4, {filterOn: ExcelScript.FilterOn.values, values: cityarr})\n  let lastrow = combined.getRange(\"A1048576\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 1 // A1 row of last thing with a 0\n  // console.log(\"2:\" + lastrow.toString())\n  if(lastrow > 1) {\n    combined.getRange(\"2:\" + lastrow.toString()).delete(ExcelScript.DeleteShiftDirection.up)\n  }\n  comfiltr.clearCriteria()\n\n\n  // 08. Filter and delete Payment Status (8) \"DECLINED\"\n  comfiltr.apply(combined.getRange(\"A:W\"), 8, {filterOn: ExcelScript.FilterOn.values, values: [\"DECLINED\"]})\n  lastrow = combined.getRange(\"A1048576\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 1 // A1 row of last thing with a 0\n  // found bug-testing: if there are no such filtered rows, it will delete the header row instead\n  // if statement only lets it delete if there's at least one row of data to remove\n  if(lastrow > 1) {\n    combined.getRange(\"2:\" + lastrow.toString()).delete(ExcelScript.DeleteShiftDirection.up)\n  }\n  comfiltr.clearCriteria()\n\n\n  // 09. Sort active range by Payment Date (0), Client Lot ID (6)\n  lastrow = combined.getRange(\"A1048576\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 1\n  combined.getRange(\"A1:W\" + lastrow.toString()).getSort().apply([{\n    key: 0,\n    ascending: true\n  }, {\n    key: 6,\n    ascending: true\n  }], false, true)\n\n  // 10. Fill G:G, R:R, AE:AE with #FFC000\n  combined.getRange(\"G:G\").getFormat().getFill().setColor(\"FFC000\")\n  combined.getRange(\"R:R\").getFormat().getFill().setColor(\"FFC000\")\n  combined.getRange(\"AE:AE\").getFormat().getFill().setColor(\"FFC000\")\n\n  // 11. Copy from Pivot Copy!A1:Clast to Combined!Y1\n  let pvtlast = pvtsheet.getRange(\"A1048576\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 1\n  combined.getRange(\"Y1\").copyFrom(pvtsheet.getRange(\"A1:C\" + pvtlast.toString()), ExcelScript.RangeCopyType.values)\n\n  // 12. Read G2:Glast and Y2:Ylast into arrays for faster reading (use values to avoid '34 != 34)\n  let clidarr = combined.getRange(\"G2:G\" + lastrow.toString()).getValues()\n  let pvidarr = combined.getRange(\"Y2:Y\" + pvtlast.toString()).getValues()\n\n  // 13. Keeping separate indexes for G nav and Y nav:\n  let i = 0\n  let j = 0\n  let y = 2 // sheet index rather than array index\n  while (i < clidarr.length && j < pvidarr.length) {\n    // 00. if G[i] == Y[j], increment i and j\n    if(clidarr[i].toString() == pvidarr[j].toString()) {\n      i ++\n      j ++\n      y ++\n    }\n    // 01. elif G[i] == Y[j-1] (i.e. multiline CLotID):\n    else if(j > 0 && (clidarr[i].toString() == pvidarr[j-1].toString())) {\n      // 00. insert cells above Y[i]:AA[i] (note, using G's index)\n      combined.getRange(\"Y\" + (y).toString() + \":AA\" + (y).toString()).insert(ExcelScript.InsertShiftDirection.down)\n      // 01. copy Y[j-1] into cell Y[i]\n      combined.getRange(\"Y\" + (y).toString()).setValue(pvidarr[j-1][0])\n      // console.log(\"Copied \" + pvidarr[j-1][0].toString())\n      // 02. increment i, do not increment j\n      i ++\n      // still, move the sheet index down 1 since something was inserted\n      y ++\n    }\n    // 02. else (i.e. extra pivot lot):\n    else {\n      // 00. delete cells at Y[j]:AA[j] (using Y's index)\n      combined.getRange(\"Y\" + (y).toString() + \":AA\" + (y).toString()).delete(ExcelScript.DeleteShiftDirection.up)\n      // console.log(\"Deleted \" + pvidarr[j][0].toString())\n      // 01. do not increment i, increment j\n      j ++\n      // no need to increment y because the next row floats up to y\n    }\n}\n\n  // 14. Check: Read G2:Glast and Y2:Ylast again, compare. Throw error if it doesn't match.\n  pvidarr = combined.getRange(\"Y2:Y\" + lastrow.toString()).getValues()\n  for(let i = 0; i < pvidarr.length; i ++) {\n    if(clidarr[i].toString() != pvidarr[i].toString()) {\n      console.log(\"Client Lot ID mismatch! Please verify manually. Crashing...\")\n      // can't find any documentation on how to throw a proper exception. This will have to do.\n      combined.getRange(\"A0\")\n    }\n  }\n\n  // 15. Write \"Total SMS Fees\", \"\", \"Final ACH Amt\", \"DPS Fees\" to AB1:AE1\n  combined.getRange(\"AB1:AE1\").setValues([[\"Total SMS Fees\",\"\",\"Final ACH Amt\",\"DPS Fees\"]])\n  // gonna do a bit of aesthetic formatting, too\n  combined.getRange(\"Y1\").clear(ExcelScript.ClearApplyTo.hyperlinks)\n  combined.getRange(\"Y1:AA1\").getFormat().getFill().setColor(\"FCE4D6\")\n  combined.getRange(\"AD:AD\").getFormat().getFill().setColor(\"D9E1F2\")\n  combined.getRange(\"AE2\").setNumberFormat(\"\\$#,##0.00\")\n\n  // 16. Write \"=Z2+AA2\", \"=Y2=G2\", \"=+W2-AB2\", \"=+AD2-R2\", \"=+AE2/99\", \"=IF(S2=0.35,0,0.99*J2)\" to AB2:AG2\n  let afRange = combined.getRange(\"AB2:AG2\")\n  afRange.setValues([[\n    \"=Z2+AA2\", \"=Y2=G2\", \"=+W2-AB2\", \"=+AD2-R2\", \"=+AE2/0.99\", \"=IF(S2=0.35,0,0.99*J2)\"\n  ]])\n\n  // 17. Autofill AB2:AG2 down to Ylast\n  afRange.autoFill(afRange.getAbsoluteResizedRange(clidarr.length, 6))\n\n  // 18. Store Ylast.getRowIndex() as recordCount\n  // this is already clidarr.length\n\n  // 19. Copy Combined!A2:Alast to Output!A2\n  let outdate1 = outsheet.getRange(\"A2\") // upleft of the 735 section\n  let outdate2 = outsheet.getRange(\"A\" + (clidarr.length + 2).toString()) // upleft of the 2206 section\n  outdate1.copyFrom(combined.getRange(\"A2:A\" + (clidarr.length + 1).toString()), ExcelScript.RangeCopyType.values)\n\n  // 20. Copy Combined!A2:Alast to Output!A[recordCount+2]\n  outdate2.copyFrom(combined.getRange(\"A2:A\" + (clidarr.length + 1).toString()), ExcelScript.RangeCopyType.values)\n\n  // 21. Copy Combined!G2:Glast to Output!B2\n  outdate1.getOffsetRange(0,1).copyFrom(combined.getRange(\"G2:G\" + (clidarr.length + 1).toString()), ExcelScript.RangeCopyType.values)\n\n  // 22. Copy Combined!G2:Glast to Output!B[recordCount+2]\n  outdate2.getOffsetRange(0,1).copyFrom(combined.getRange(\"G2:G\" + (clidarr.length + 1).toString()), ExcelScript.RangeCopyType.values)\n\n  // 23. Write 735 to Output!C2:C[recordCount+1]\n  outdate1.getOffsetRange(0,2).setValue(735)\n  outdate1.getOffsetRange(0,2).getAbsoluteResizedRange(clidarr.length, 1).copyFrom(outdate1.getOffsetRange(0,2))\n\n  // 24. Write 2206 to Output!C[recordCount+2]:C[2*recordCount+1]\n  outdate2.getOffsetRange(0, 2).setValue(2206)\n  outdate2.getOffsetRange(0, 2).getAbsoluteResizedRange(clidarr.length, 1).copyFrom(outdate2.getOffsetRange(0, 2))\n\n  // 25. Copy Combined!R2:Rlast to Output!D2\n  outdate1.getOffsetRange(0,3).copyFrom(combined.getRange(\"R2:R\" + (clidarr.length + 1).toString()), ExcelScript.RangeCopyType.values)\n  \n  // 26. Copy Combined!AE2:AElast to Output!D[recordCount+2]\n  outdate2.getOffsetRange(0, 3).copyFrom(combined.getRange(\"AE2:AE\" + (clidarr.length + 1).toString()), ExcelScript.RangeCopyType.values)\n\n  // 27. Add autofilter, filter and delete Amount (3) == 0\n  let outftr = outsheet.getAutoFilter() \n  outftr.apply(outsheet.getRange(\"A1:D1\")) // activate filter on A:D\n  outftr.apply(outftr.getRange(), 3, {filterOn: ExcelScript.FilterOn.values, values: [\"0\"]})\n  lastrow = outsheet.getRange(\"A1048576\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 1\n  outsheet.getRange(\"2:\" + lastrow.toString()).delete(ExcelScript.DeleteShiftDirection.up)\n  outftr.clearCriteria()\n\n  // 28. Sort by Date -> Station -> NS Account\n  lastrow = outsheet.getRange(\"A1048576\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 1\n  outsheet.getRange(\"A2:D\" + lastrow.toString()).getSort().apply([\n    {ascending: true, key: 0},\n    {ascending: true, key: 1},\n    {ascending: true, key: 2}\n  ])\n\n  // 29. Human Input: copy to template, fix N/A, verify, and save!\n  console.log(\"Your turn! :)\")\n}\n\nfunction main(workbook: ExcelScript.Workbook) {\n  // Get the active cell and worksheet.\n  let selectedCell = workbook.getActiveCell();\n  let selectedSheet = workbook.getActiveWorksheet();\n\n  // let lastrow = selectedSheet.getRange(\"A1048576\").getExtendedRange(ExcelScript.KeyboardDirection.up).getRowIndex() + 1\n\n  pbp(workbook)\n\n  // console.log(\"[\" + selectedCell.getNumberFormat() + \"]\")\n\n  // TODO: Write code or use the Insert action button below.\n\n}\n","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}