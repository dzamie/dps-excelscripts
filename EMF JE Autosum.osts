{"version":"0.3.0","body":"// Assumptions:\n//  -----------------------------------------------\n// | Paste raw data to A/I/R9. ALWAYS 9, even ANCH |\n//  -----------------------------------------------\n\n// changelog:\n// 2025.10.09\n//   adding support for Station 5004:\n//     reformatted Anchorage sheet to support 4th station\n//     1st-column A/I/R updated to A/I/N/S\n//     similar for 2nd and 5th column\n\n\n// New Plan:\n// destination cell: A3/I3/N3/S3, putting cc/corpo/echeck in one block first\n// read cell: B/J/O9/T9, extend right and down if exists\n// make Object for holding stuff\n// use filename to name Data top layer: \"B500\", \"U131\", etc\n// Data[\"B500\"][\"data\"] = Spokane/s B9:.. values and so on\n// store sheet's used area's last cell to clear LATER with getBoundingRect(A9)\n// [\"B500\"][\"+1804\"][\"data\"] = \"b500\"\"data\".filter(a => a[0].includes(\"WSS\") && a[3] > 0)\n// [\"+1804\"][\"name\"] = 1804, [\"sum\"] \"1804\"\"data\".reduce((acc, cur) => acc + cur[3], 0) (quick sum)\n// etc. for all 5 +/-\n// cleanup: loop thru Object.keys(\"B500\") copy; any key with 0 \"sum\" gets deleted\n// one last one: [\"junk\"] key for not including any incl strings (cc, corpo, echeck, general catcher)\n// [\"B500\"][\"dout\"] (data out) is each key (starting with junk, then excluding junk in the loop)'s data,\n//   separated by 2 [\"\", \"\", \"\", \"\"]s\n// [\"B500\"][\"sout\"] (sum out) is [name, sum] for each non-junk key\n//\n// processing done, now for some writing\n//\n// create JEarr<Array<any>>\n// each value becomes\n// Station  Code    -sum    +sum    memo\n// '0       bank    +sum    -sum    memo\n// (station, bank, memo found from, well, station)\n// stitch souts together\n// write each station's dout to A3/I3/N3/S3\n// write the stitch to F9\n// write JEarr to W5\n// find range W5:AA5, extend down\n// set as active range\n// ggez\n\n\n\n// Includes strings:\n// 1804 WSS\n// 3010 Mail\n// 3015 WebSelfStorage\n// 2400 Call Center\n// 4003 Internet Customer\n\n// takes the raw chunk of **4-column** data, returns output: Object\n// useful keys in output: \"dout\" (data out) \"sout\" (sum out)\nfunction processStation(input: Array<Array<string | number | boolean>>) {\n    let output = {}\n    let inclStr = {\"1804\": \"WSS\",\n                   \"3010\": \"Mail\",\n                   \"3015\": \"WebSelfStorage\",\n                   \"2400\": \"Call Center\",\n                   \"4003\": \"Internet Customer\"}\n    let codes = Object.keys(inclStr)\n    for (let i = 0; i < codes.length; i++) {\n        // set up pairs of pos/neg codes\n        // it's *probably* just 1804 that'll use both, but just in case\n        output[\"+\" + codes[i]] = Array<Array<string | number>>()\n        output[\"-\" + codes[i]] = Array<Array<string | number>>()\n    }\n    // this is for CC/Echeck/Corpo/etc, that goes above the rest\n    output[\"Junk\"] = Array<Array<string | number>>()\n    for(let i = 0; i < input.length; i ++ ) {\n        let found = false\n        for(let j = 0; j < codes.length; j ++) {\n            // check which label matcher the label, well, matches\n            if(input[i][0].toString().includes(inclStr[codes[j]])) {\n                found = true\n                // ternary op to make sure it goes to the correct sign of the code\n                output[(input[i][3] > 0 ? \"+\" : \"-\") + codes[j]].push(input[i])\n            }\n        }\n        if(!found) { // matched none\n            output[\"Junk\"].push(input[i])\n        }\n    }\n    \n    // now separated into appropriate codes\n    let codeCopy = Object.keys(output).slice() // copy the array so indexes don't get weird during deletions\n    for(let i = 0; i < codeCopy.length; i ++) {\n        if(output[codeCopy[i]].length < 1) { // delete anything without a single item\n            delete output[codeCopy[i]]\n        }\n    }\n    let dout = Array<Array<number | string | boolean>>()\n    let sout = Array<Array<number | string>>()\n    let blank = [[\"\", \"\", \"\", \"\"]]\n\n    if(output.hasOwnProperty(\"Junk\")) { // prevents an undefined entry if no CC/Echecks happened\n        dout = dout.concat(output[\"Junk\"], blank, blank, blank)\n        delete output[\"Junk\"]\n    }\n    \n\n    codeCopy = Object.keys(output).slice() // update keys\n\n    for(let i = 0; i < codeCopy.length; i ++) {\n        let foo = 3\n        foo = output[codeCopy[i]].reduce((acc, cur) => acc + cur[3], 0) // calculate sum per code\n        dout = dout.concat(output[codeCopy[i]])\n        sout = sout.concat([[codeCopy[i].slice(1), foo]]) // label sum with number-only part of code\n        dout = dout.concat([[\"\", \"\", \"\", foo]]) // mimic autosum\n        dout = dout.concat(blank) // aesthetic\n    }\n    \n    return {\n        \"dout\": dout,\n        \"sout\": sout\n    }\n\n}\n\n\n\nfunction main(workbook: ExcelScript.Workbook) {\n    let selectedSheet = workbook.getActiveWorksheet();\n\n    // console.log(workbook.getName().includes(\"Anch\"))\n\n    let manager = {}\n    let sums = Array<Array<string | number | boolean>>()\n    let fname = workbook.getName()\n    for(let i = 0; i < 4; i ++) {\n        let foo = selectedSheet.getRange([\"A\",\"I\",\"N\",\"S\"][i] + \"9\")\n        if(foo.getSpecialCells(ExcelScript.SpecialCellType.blanks) == undefined) { // if something exists\n            selectedSheet.getRange([\"D:D\",\"L:L\",\"U:U\"][i]).setNumberFormat(\"$#,##0.00_);[Red]($#,##0.00)\")\n            let processed = processStation(selectedSheet.getRange([\"B\", \"J\", \"O\", \"T\"][i] + \"9:\" + [\"E\", \"M\", \"R\", \"W\"][i] + \"9\").getExtendedRange(ExcelScript.KeyboardDirection.down).getExtendedRange(ExcelScript.KeyboardDirection.down).getExtendedRange(ExcelScript.KeyboardDirection.up).getValues())\n            // clear out what was there\n            foo.getAbsoluteResizedRange(1,5).getExtendedRange(ExcelScript.KeyboardDirection.down).clear(ExcelScript.ClearApplyTo.contents)\n            // add in properly-formatted data\n            foo.getOffsetRange(-5,0).getAbsoluteResizedRange(processed[\"dout\"].length, processed[\"dout\"][0].length).setValues(processed[\"dout\"])\n            manager[i.toString()] = processed[\"sout\"]\n            sums = sums.concat(processed[\"sout\"], [[\"\", \"\"]])\n        }\n    }\n\n    // print and label codes and sums for checking against bank\n    // if there's only CC/Echeck data, with no code-able lines, the program crashes here\n    // but that's fine, since there's no need to generate an EMF JE\n    selectedSheet.getRange(\"F9\").getAbsoluteResizedRange(sums.length, sums[0].length).setValues(sums)\n    selectedSheet.getRange(\"F9\").getAbsoluteResizedRange(sums.length, 1).setNumberFormat(\"General\")\n    selectedSheet.getRange(\"G9\").getAbsoluteResizedRange(sums.length, 1).setNumberFormat(\"$#,##0.00_);[Red]($#,##0.00)\")\n\n    // time to generate EMF JE stuff\n    // hint: manager.hasOwnProperty(key) with '0' '1' '2'\n    // ^ that plus fname.includes(anch/slc/spokane) will give station, bank, memo\n\n\n    \n    let jeArr = Array<Array<number | string>>()\n    // Station  Code    -sum    +sum    memo\n    // '0       bank    +sum    -sum    memo\n    let station = \"\"\n    let bank = 0\n    let memoBase = \"WSS EMF \"\n    let memo = \"\"\n    for(let i = 0; i < 4; i ++) {\n        if(! manager.hasOwnProperty(i.toString())) {\n            continue // skip over this i-val if the data is blank\n        }\n        // set station/bank/memo values\n        if(fname.includes(\"Anch\")) {\n            station = \"5001\"\n            bank = 10053\n            if(i == 0) {\n                memo = memoBase + \"5001\"\n            } else if(i == 1) {\n                station = \"5003\"\n                bank = 10216\n                memo = memoBase + \"5003\"\n            } else if(i == 2) {\n                memo = memoBase + \"5002\"\n            } else if(i == 3) {\n                memo = memoBase + \"5004\"\n            }\n        } else if(fname.includes(\"SLC\")) {\n            bank = 10331\n            memo = memoBase + \"SLC\"\n            station = (i == 0) ? \"U131\" : \"U130\"\n        } else {\n            bank = 10304\n            memo = memoBase + \"Spokane\"\n            station = (i == 0) ? \"B500\" : \"B600\"\n        }\n\n        // can now know that manager[i] contains sout (array of [code, sum])\n        for(let j = 0; j < manager[i.toString()].length; j ++) {\n            let sum : Array<string | number> = manager[i.toString()][j] // readability\n            if(sum[1] < 0) { // red sum!\n                jeArr.push([station,  sum[0],   -sum[1],  \"\",        memo])\n                jeArr.push([\"'0\",     bank,     \"\",       -sum[1],   memo])\n            } else { // black sum!\n                jeArr.push([station,  sum[0],   \"\",       sum[1],    memo])\n                jeArr.push([\"'0\",     bank,     sum[1],   \"\",        memo])\n            }\n        }\n    }\n    \n    // jeArr is hopefully populated now\n    // time to put it on W5:AA???\n    selectedSheet.getRange(\"W5\").getAbsoluteResizedRange(jeArr.length, 5).setValues(jeArr)\n    let wssOut = selectedSheet.getRange(\"W5:AA5\").getExtendedRange(ExcelScript.KeyboardDirection.down)\n    wssOut.select()\n    // not sure if this format will work, but if not, it crashes only after everything necessary is done\n    // will come back to fix if needed, though, because always crashing is not great\n    wssOut.setNumberFormat(\"General\")\n}\n\n// didn't wind up needing this anyway but it's good to know how to do\n// function testSort(a: Array<Array<number>>, b: Array<Array<number>>) {\n//     if(a[0] == b[0]) {\n//         if(a[1] == b[1]) {\n//             return 0\n//         } else {\n//             return (a[1] < b[1] ? -1 : 1)\n//         }\n//     } else {\n//         return (a[0] < b[0] ? -1 : 1)\n//     }\n// }","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}