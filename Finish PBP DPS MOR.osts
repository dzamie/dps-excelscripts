{"version":"0.3.0","body":"// TODO: prepend Lot IDs with ' to make them stringlike\n\n/* \n\nHuman Method:\n 0. Sheet1:\n 1. Insert 2 columns between S, T\n 2. Label T4 \"DPS Fee\", U4 \"PBP Fee\"\n 3. T5 = \"=VLOOKUP(Y5,'Station Fees'!$A:$B,2,FALSE)\"\n 4. U5 = \"=K5 - T5\"\n 5. fill down for T,U\n 6. Hide D:H, L:R, AD:AI\n 7. Filter + delete Payment Status (AC) = DECLINED\n 8. Sheet2:\n 9. Update pivot table to new data\n10. Add \"DPS Fee\" and \"PBP Fee\" to value columns\n11. Import Template:\n12. Refresh All\n13. Sort: Subsidiary External ID -> Station# -> NetSuite Account\n14. Delete when B = 0 down\n15. Sheet1:\n16. Refresh pivot table\n\nProgram Method:\n 0. Sheet1:\n 1. Copy A4:AI4 (1x37) to array\n 2. Insert \"DPS Fee\", \"PBP Fee\" before label[19]\n 3. Copy A5:right,down formulas to array\n 4. Delete rows where row[26] contains \"DECLINED\"\n 5. foreach row i of data[]:\n   1. Insert \"=VLOOKUP(Y[i+5],'Station Fees'!$A:$B,2,FALSE)\" before label[19]\n   2. Insert \"=K[i+5] - T[i+5]\" before label[20]\n 6. Hide D:H, L:R, AD:AI\n 7. Sheet2:\n 8. Replace pivot with new pivot at A1: Sheet1!A4:right,down\n 9. Add Client Lot ID to rows hierarchy\n10. Add Parking Amount, PayByPhone Consumer Fee, DPS Fee, PBP Fee to values hierarchy\n11. Import Template:\n12. Refresh All\n13. Sort: Subsidiary External ID -> Station# -> NetSuite Account\n14. Find first row where B[r] = \"0\"\n15. Delete \"r:r\":down (shift up)\n16. Sheet1:\n17. Replace pivot table with new pivot at AK6: Import Template!A1:right,down\n18. Add Subsidiary External ID to row hierarchy\n19. Add Amount to values hierarchy\n20. Activate A1\n21. Activate AK12\n\n*/\n\nfunction main(workbook: ExcelScript.Workbook) {\n  let s1 = workbook.getWorksheet(\"Sheet1\")\n  let s2 = workbook.getWorksheet(\"Sheet2\")\n  let it = workbook.getWorksheet(\"Import Template\")\n  let lblarr = s1.getRange(\"A4:AI4\").getValues()\n  let origdata = s1.getRange(\"A5:AI5\").getExtendedRange(ExcelScript.KeyboardDirection.down) \n  let dataarr = origdata.getFormulas()\n  \n  // add column labels\n  lblarr[0].splice(19, 0, \"DPS Fee\", \"PBP Fee\")\n  s1.getRange(\"A4:AK4\").setValues(lblarr)\n\n  // remove declined transactions\n  dataarr = dataarr.filter((row) => row[26].includes(\"APPROVED\"))\n  \n  // insert vlookup and subtraction formulae into each remaining row\n  for(let i = 0; i < dataarr.length; i ++) {\n    let i5 = (i+5).toString()\n    dataarr[i].splice(19, 0,\n    \"=VLOOKUP(Y\" + i5 + \",'Station Fees'!$A:$B,2,FALSE)\",\n      \"=K\" + i5 + \" - T\" + i5)\n    // new! turn client lots back into strings\n    dataarr[i][24] = \"'\" + dataarr[i][24].toString()\n  }\n\n  // remove old data\n  origdata.clear()\n\n  // put it back, hide unnecessary columns\n  s1.getRange(\"A5\").getAbsoluteResizedRange(dataarr.length, dataarr[0].length).setFormulas(dataarr)\n  s1.getRange(\"D:H\").setColumnHidden(true)\n  s1.getRange(\"L:R\").setColumnHidden(true)\n  s1.getRange(\"AD:AK\").setColumnHidden(true)\n\n  // update (replace) pivot table with accurate data source\n  s2.getPivotTables()[0].delete()\n  let mainpvt = s2.addPivotTable(\"MainPivot\", s1.getRange(\"A4\").getAbsoluteResizedRange(dataarr.length + 1, dataarr[0].length), \"A1\")\n  // (minor) makes the payment date look normal\n  // rather than the decimal format that excel technically stores time as\n  s1.getRange(\"C:C\").setNumberFormat(\"mm/dd/yy hh:mm:ss\")\n\n  // re-add row and data hierarchies\n  mainpvt.addRowHierarchy(mainpvt.getHierarchy(\"Client Lot ID\"))\n  let data_names = [\"Parking Amount\", \"PayByPhone Consumer Fee\", \"DPS Fee\", \"PBP Fee\"]\n  data_names.forEach((n) => mainpvt.addDataHierarchy(mainpvt.getHierarchy(n)).setSummarizeBy(ExcelScript.AggregationFunction.sum))\n\n\n  // refresh all to fix import template, just in case\n  // have to enable content manually. maybe refresh manually? ugh hopefully not. all because\n  // workbook.refreshAllLinksToLinkedWorkbooks()\n  // doesn't work on this version of excel\n  workbook.refreshAllDataConnections()\n\n  // sort by company #, then station, then netsuite acct\n  it.getUsedRange().getSort().apply(\n    [{key: 8, ascending: true},\n     {key: 1, ascending: true},\n     {key: 2, ascending: true}],\n     false,\n     true\n  )\n\n  // find first row in B with \"0\"\n  // then delete everything after it\n  let first0 = it.getRange(\"B:B\").find(\"0\", {completeMatch: true})\n  \n  first0.getExtendedRange(ExcelScript.KeyboardDirection.down).getEntireRow().delete(ExcelScript.DeleteShiftDirection.up)\n  \n  // replace pivot table with new one at AM6\n  s1.getPivotTables()[0].delete()\n  let sumpvt = s1.addPivotTable(\"SummaryPivot\", it.getRange(\"A1\").getExtendedRange(ExcelScript.KeyboardDirection.right).getExtendedRange(ExcelScript.KeyboardDirection.down), \"AM6\")\n  sumpvt.addRowHierarchy(sumpvt.getHierarchy(\"Subsidiary External ID\"))\n  sumpvt.addDataHierarchy(sumpvt.getHierarchy(\"Amount\")).setSummarizeBy(ExcelScript.AggregationFunction.sum)\n\n  // move cursor\n  s1.getRange(\"A1\").select()\n  s1.getRange(\"AM12\").select()\n\n\n}\n","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}